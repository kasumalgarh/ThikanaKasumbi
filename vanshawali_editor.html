<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanshawali Editor Pro - KASUMALGARH</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="royal_global.css?v=2">

    <style>
        /* --- ROYAL ADMIN STYLES --- */
        body { background-color: #000022; background-image: url('https://www.transparenttextures.com/patterns/black-scales.png'); padding-bottom: 120px; font-family: 'Playfair Display', serif; }
        
        /* üîí Login Overlay */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(0,0,51,0.95), rgba(0,0,51,0.98)), url('1.jpg'); background-size: cover; background-position: center; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { text-align: center; border: 4px double #b38728; padding: 40px; border-radius: 15px; background: rgba(0, 0, 34, 0.95); box-shadow: 0 0 30px rgba(179, 135, 40, 0.3); width: 90%; max-width: 350px; }
        .pin-input { font-size: 2em; text-align: center; padding: 10px; width: 100%; background: #000; color: #b38728; border: 2px solid #b38728; margin-top: 20px; font-family: 'Cinzel', serif; letter-spacing: 5px; border-radius: 5px; }
        .btn-unlock { margin-top: 20px; padding: 12px 30px; background: linear-gradient(to right, #bf953f, #aa771c); color: #000; border: 2px solid #fcf6ba; font-weight: 900; cursor: pointer; font-family: 'Cinzel'; width: 100%; font-size: 1.1em; border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        /* üõ†Ô∏è Editor Container */
        .editor-container { max-width: 1100px; margin: 40px auto; padding: 15px; opacity: 0.1; pointer-events: none; transition: 0.5s; }
        .editor-active { opacity: 1 !important; pointer-events: auto !important; }

        /* Config Card */
        .admin-card { background: var(--paper-bg); padding: 25px; border: 3px double var(--maroon-text); border-radius: 15px; position: relative; box-shadow: 0 0 25px rgba(191, 149, 63, 0.3); margin-bottom: 25px; }
        .config-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .config-input { background: #fff; border: 2px solid #b38728; color: #333; padding: 10px; flex: 1; min-width: 200px; border-radius: 5px; font-weight: bold; }

        /* Toolbar */
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; background: #000044; padding: 15px; border-radius: 10px; border: 1px solid #b38728; flex-wrap: wrap; }
        .search-input { flex: 1; padding: 10px; border: 2px solid #b38728; background: #000; color: #fcf6ba; border-radius: 5px; font-family: 'Cinzel'; }
        .btn-tool { padding: 10px 20px; border: 1px solid #b38728; cursor: pointer; border-radius: 5px; background: #000066; color: #fcf6ba; font-family: 'Cinzel'; font-weight: bold; transition: 0.3s; }
        .btn-tool:hover { background: #b38728; color: #000; }
        .btn-undo { border-color: #ff9900; color: #ff9900; }

        /* Tree Nodes */
        #editor-area { padding-bottom: 50px; }
        .node-box { background: rgba(255, 255, 255, 0.95); border-left: 5px solid #b38728; margin: 10px 0 10px 30px; padding: 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; transition: 0.3s; }
        .node-box:hover { transform: translateX(5px); border-color: var(--maroon-text); }
        .node-box::before { content: ""; position: absolute; left: -30px; top: 20px; width: 30px; height: 2px; background: #b38728; }
        
        .node-row { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .edit-input { border: 1px solid #ccc; padding: 8px; border-radius: 4px; width: 200px; font-family: 'Playfair Display', serif; }
        .btn-mini { padding: 5px 10px; font-size: 0.8em; border-radius: 4px; cursor: pointer; border: 1px solid #b38728; background: #fffbf0; font-weight: bold; }
        .btn-add { color: green; border-color: green; }
        .btn-del { color: red; border-color: red; }

        .highlight-node { border: 3px solid red !important; background: #fff0f0 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* Sticky Footer */
        .sticky-footer-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #000033; border-top: 3px solid #b38728; padding: 15px; display: flex; gap: 15px; z-index: 2000; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .big-btn { flex: 1; padding: 15px; font-family: 'Cinzel'; font-weight: 900; border-radius: 50px; cursor: pointer; border: 2px solid #fcf6ba; font-size: 1.1em; text-transform: uppercase; }
        .btn-load { background: #000066; color: #fcf6ba; }
        .btn-save { background: linear-gradient(to right, #bf953f, #aa771c); color: #000; }
        
        /* Mobile */
        @media (max-width: 600px) { .node-box { margin-left: 15px; padding: 10px; } .node-box::before { width: 15px; left: -15px; } .edit-input { width: 120px; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="font-family:'Cinzel'; color:#b38728; margin-bottom:10px;">ROYAL ADMIN</h2>
            <div style="color:#fcf6ba; font-size:0.9em; margin-bottom:20px;">Vanshawali Control Panel</div>
            <input type="password" id="pin-input" class="pin-input" maxlength="4" placeholder="****">
            <button class="btn-unlock" onclick="checkPin()">UNLOCK GATE</button>
        </div>
    </div>

    <nav class="navbar">
        <div class="navbar-brand-container">
            <img id="menu-logo" src="menulogo.png" alt="Logo"> 
            <a class="navbar-brand" href="index.html">KASUMALGARH</a>
        </div>
        <div class="menu-toggle" onclick="toggleMobilePopup()"><i class="fa-solid fa-bars"></i></div>
        <ul class="navbar-links">
            <li><a href="index.html">HOME</a></li>
            <li><a href="vanshawali.html">VANSHAWALI</a></li>
            <li><a href="gallery_editor.html">GALLERY EDITOR</a></li>
            <li><a href="#" class="active" style="color:#b38728;">TREE EDITOR</a></li>
        </ul>
    </nav>

    <div id="editor-ui" class="editor-container">
        
        <div class="admin-card">
            <h3 style="font-family:'Cinzel'; color:var(--maroon-text); text-align:center; margin:0 0 15px 0;">‚öôÔ∏è Connection</h3>
            <div class="config-row">
                <input type="password" id="gh-token" class="config-input" placeholder="GitHub Token">
                <input type="text" id="gh-owner" class="config-input" placeholder="Username (kasumalgarh)">
                <input type="text" id="gh-repo" class="config-input" placeholder="Repo Name (kasumalgarh.github.io)">
            </div>
        </div>

        <div class="toolbar">
            <input type="text" id="search-input" class="search-input" placeholder="üîç Search Name..." onkeyup="if(event.key==='Enter') searchNode()">
            <button class="btn-tool" onclick="searchNode()">Find</button>
            <button class="btn-tool btn-undo" id="btn-undo" onclick="performUndo()" disabled>‚Ü© Undo</button>
        </div>

        <div id="editor-area">
            <p style="text-align:center; margin-top:50px; color:#aaa; font-style:italic;">
                Click "Load Tree" to start editing the lineage.
            </p>
        </div>
    </div>

    <div class="sticky-footer-bar">
        <button class="big-btn btn-load" onclick="fetchFromGitHub()">üå≥ Load Tree</button>
        <button id="save-btn" class="big-btn btn-save" onclick="saveToGitHub()">üíæ Save Changes</button>
    </div>

    <div id="mobile-popup" class="mobile-menu-overlay">
        <ul class="mobile-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="vanshawali.html">Vanshawali</a></li>
            <li><a href="gallery_editor.html">Gallery Editor</a></li>
        </ul>
    </div>

    <script src="mainscript.js"></script>

    <script>
        // --- 1. ADMIN LOGIC ---
        let currentTreeData = null, fileSha = "", historyStack = [];
        const FILE_PATH = "family-data.js";
        const PIN = "2025";

        function checkPin() {
            if(document.getElementById('pin-input').value === PIN) {
                document.getElementById('login-overlay').style.opacity = "0";
                setTimeout(() => { 
                    document.getElementById('login-overlay').style.display = "none"; 
                    document.getElementById('editor-ui').classList.add('editor-active');
                }, 500);
                loadConfig();
            } else { alert("Wrong PIN!"); }
        }

        function loadConfig() {
            if(localStorage.getItem('gh-token')) document.getElementById('gh-token').value = localStorage.getItem('gh-token');
            if(localStorage.getItem('gh-owner')) document.getElementById('gh-owner').value = localStorage.getItem('gh-owner');
            if(localStorage.getItem('gh-repo')) document.getElementById('gh-repo').value = localStorage.getItem('gh-repo');
        }

        // ‚úÖ FETCH FUNCTION (With atob Fix)
        async function fetchFromGitHub() {
            const token = document.getElementById('gh-token').value.trim();
            const owner = document.getElementById('gh-owner').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const btn = document.querySelector('.btn-load');
            const originalText = btn.innerText;

            if(!token || !owner || !repo) return alert("Fill Config details first!");
            
            // Save settings
            localStorage.setItem('gh-token', token);
            localStorage.setItem('gh-owner', owner);
            localStorage.setItem('gh-repo', repo);

            btn.innerText = "‚è≥ Loading...";

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${FILE_PATH}`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                
                if (!res.ok) throw new Error("Load Failed! Check Token/Repo Name.");
                
                const data = await res.json();
                fileSha = data.sha;
                
                // ‚úÖ FIX: Clean newlines before decoding
                const cleanContent = data.content.replace(/\s/g, ''); 
                const content = decodeURIComponent(atob(cleanContent).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                
                currentTreeData = JSON.parse(content.replace("const familyData =", "").replace(";", "").trim());
                renderEditor();
                alert("Tree Loaded Successfully! üå≥");
            } catch (e) { alert("‚ùå Error: " + e.message); } 
            finally { btn.innerText = originalText; }
        }

        function renderEditor() {
            const area = document.getElementById('editor-area');
            area.innerHTML = "";
            if(currentTreeData) area.appendChild(createNode(currentTreeData, null, -1));
        }

        function createNode(node, parent, idx) {
            const div = document.createElement('div');
            div.className = "node-box";
            div.innerHTML = `
                <div class="node-row">
                    <span style="color:#b38728; font-size:1.2em;">üë§</span>
                    <input type="text" class="edit-input" value="${node.name}" onfocus="saveHistory()" onchange="node.name=this.value" placeholder="Name">
                    <input type="text" class="edit-input" style="font-size:0.9em; color:#666;" value="${node.title || ''}" onfocus="saveHistory()" onchange="node.title=this.value" placeholder="Title/Spouse">
                    <button class="btn-mini btn-add" onclick="addChild('${node.name}')">+ Child</button>
                    ${parent ? `<button class="btn-mini btn-del" onclick="deleteNode('${node.name}')">üóëÔ∏è</button>` : ''}
                </div>
            `;
            if(node.children) node.children.forEach((c, i) => div.appendChild(createNode(c, node, i)));
            return div;
        }

        function saveHistory() {
            historyStack.push(JSON.stringify(currentTreeData));
            if(historyStack.length > 20) historyStack.shift();
            document.getElementById('btn-undo').disabled = false;
        }

        function performUndo() {
            if(!historyStack.length) return;
            currentTreeData = JSON.parse(historyStack.pop());
            renderEditor();
            document.getElementById('btn-undo').disabled = historyStack.length === 0;
        }

        function findAndAction(data, targetName, action, payload) {
            if(data.name === targetName) {
                if(action === 'add') {
                    if(!data.children) data.children = [];
                    data.children.push(payload);
                }
                return true;
            }
            if(data.children) {
                for(let i=0; i<data.children.length; i++) {
                    if(action === 'delete' && data.children[i].name === targetName) {
                        data.children.splice(i, 1); return true;
                    }
                    if(findAndAction(data.children[i], targetName, action, payload)) return true;
                }
            }
            return false;
        }

        function addChild(parentName) {
            const newName = prompt("Enter Name for new child:");
            if (!newName || newName.trim() === "") return; 
            saveHistory();
            findAndAction(currentTreeData, parentName, 'add', { name: newName.trim(), title: "", children: [] });
            renderEditor();
        }

        function deleteNode(name) {
            if(confirm(`Delete ${name} and all descendants?`)) {
                saveHistory();
                findAndAction(currentTreeData, name, 'delete');
                renderEditor();
            }
        }

        function searchNode() {
            const q = document.getElementById('search-input').value.toLowerCase();
            document.querySelectorAll('.highlight-node').forEach(n => n.classList.remove('highlight-node'));
            if(!q) return;
            const inputs = document.querySelectorAll('.edit-input');
            for(let i of inputs) {
                if(i.value.toLowerCase().includes(q)) {
                    const box = i.closest('.node-box');
                    box.classList.add('highlight-node');
                    box.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    break;
                }
            }
        }

        async function saveToGitHub() {
            if(!currentTreeData) return alert("Load tree first!");
            const btn = document.getElementById('save-btn');
            btn.innerText = "Saving...";
            
            const token = document.getElementById('gh-token').value;
            const owner = document.getElementById('gh-owner').value;
            const repo = document.getElementById('gh-repo').value;

            try {
                // Get SHA
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${FILE_PATH}`;
                const check = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                const checkData = await check.json();
                
                // Encode
                const finalJSON = `const familyData = ${JSON.stringify(currentTreeData, null, 4)};`;
                const encoded = btoa(encodeURIComponent(finalJSON).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
                
                await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "Vanshawali Update via Admin", content: encoded, sha: checkData.sha })
                });
                
                alert("Saved Successfully! ‚úÖ Live in 1-2 mins.");
            } catch (e) { alert("Save Failed: " + e.message); }
            finally { btn.innerText = "üíæ Save Changes"; }
        }

        function toggleMobilePopup() {
            const menu = document.getElementById('mobile-popup');
            if(menu.classList.contains('open')) menu.classList.remove('open');
            else menu.classList.add('open');
        }
    </script>
</body>
</html>