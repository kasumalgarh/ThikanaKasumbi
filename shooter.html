<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Khush Space Defender</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050510;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none; /* मोबाइल स्क्रॉल रोकें */
            user-select: none;
        }

        canvas {
            display: block;
        }

        /* --- UI Layers --- */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Heads Up Display (HUD) */
        .hud-top {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        .score-box {
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 5px #00ffff;
        }

        .level-box {
            color: #ffff00;
            font-size: 20px;
            font-weight: bold;
        }

        .pilot-name {
            color: #ff00ff;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Health Bar */
        #health-container {
            width: 200px;
            height: 15px;
            background: #333;
            border: 2px solid white;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        #health-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff3333, #00ff00);
            transition: width 0.2s;
        }

        /* Controls UI (Touch Buttons) */
        .hud-bottom {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: auto;
        }

        .action-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid white;
            font-weight: bold;
            font-size: 14px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            opacity: 0.8;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.9); opacity: 1; }

        #btn-nuke {
            background: radial-gradient(circle, #ff0000, #990000);
            border-color: #ff3333;
        }
        #btn-pause {
            width: 50px;
            height: 50px;
            background: #444;
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: auto;
            border-radius: 10px;
            display: flex; /* Initially hidden, shown in JS */
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }

        /* Screens (Start, Game Over) */
        .screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(10, 10, 20, 0.95);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            pointer-events: auto;
            min-width: 300px;
            z-index: 10;
        }

        h1 { margin: 0; color: #00ffff; font-size: 32px; text-transform: uppercase; }
        h2 { margin: 5px 0 20px 0; color: #ff00ff; font-size: 18px; }
        p { color: #ccc; margin-bottom: 20px; }
        
        button.main-btn {
            background: linear-gradient(45deg, #00ccff, #0066ff);
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 150, 255, 0.5);
            margin-top: 10px;
        }

        .high-score {
            margin-top: 15px;
            color: #ffff00;
            font-weight: bold;
        }

        /* Notification for Level Up / Powerups */
        #notification {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px #ff00ff;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <!-- Top HUD -->
        <div class="hud-top">
            <div>
                <div class="score-box">SCORE: <span id="score-val">0</span></div>
                <div class="pilot-name">PILOT: KHUSH</div>
                <div id="health-container"><div id="health-fill"></div></div>
            </div>
            <div id="btn-pause">⏸</div>
            <div style="text-align: right;">
                <div class="level-box">LEVEL <span id="level-val">1</span></div>
                <div style="font-size: 12px; color: #aaa;">HI-SCORE: <span id="hiscore-val">0</span></div>
            </div>
        </div>

        <!-- Notification Text -->
        <div id="notification">LEVEL UP!</div>

        <!-- Bottom Controls -->
        <div class="hud-bottom">
            <!-- Nuke Button -->
            <div id="btn-nuke" class="action-btn">
                <span>☢ NUKE</span>
                <span id="nuke-count" style="font-size: 10px;">(3)</span>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="screen">
        <h1>Khush Space Shooter</h1>
        <h2>Mission: Save the Galaxy!</h2>
        <p>
            Phone को बाएँ-दाएँ झुकाकर (Tilt) जहाज चलाएं।<br>
            या टच करके Drag करें।
        </p>
        <button class="main-btn" id="start-btn">मिशन शुरू करें</button>
        <div class="high-score">High Score: <span id="start-hiscore">0</span></div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="screen" style="display: none;">
        <h1 style="color: #ff3333;">MISSION FAILED</h1>
        <p>Well played, Captain Khush!</p>
        <p>Final Score: <span id="final-score">0</span></p>
        <button class="main-btn" onclick="resetGame()">Try Again</button>
    </div>

    <!-- Pause Screen -->
    <div id="pause-screen" class="screen" style="display: none;">
        <h1>PAUSED</h1>
        <button class="main-btn" onclick="togglePause()">Resume</button>
    </div>

    <script>
        // --- Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const scoreEl = document.getElementById('score-val');
        const levelEl = document.getElementById('level-val');
        const healthFill = document.getElementById('health-fill');
        const hiScoreEl = document.getElementById('hiscore-val');
        const startHiScoreEl = document.getElementById('start-hiscore');
        const nukeCountEl = document.getElementById('nuke-count');
        const notificationEl = document.getElementById('notification');
        
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const pauseScreen = document.getElementById('pause-screen');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('btn-pause');
        const nukeBtn = document.getElementById('btn-nuke');

        // Audio Context (Web Audio API)
        let audioCtx;
        
        // Game State
        let gameState = {
            active: false,
            paused: false,
            score: 0,
            level: 1,
            highScore: localStorage.getItem('khushShooterHighScore') || 0,
            nukes: 3,
            frameCount: 0,
            shake: 0
        };

        // Resize Handling
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Update High Score Display
        hiScoreEl.innerText = gameState.highScore;
        startHiScoreEl.innerText = gameState.highScore;

        // --- Sound System (Synthesizer) ---
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'shoot') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'explosion') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.3);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'powerup') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'nuke') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 1.0);
                osc.start(now);
                osc.stop(now + 1.0);
            }
        }

        // --- Input Handling ---
        const keys = {};
        let tiltX = 0;
        
        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => {
            keys[e.key] = false;
            if (e.key === 'p' || e.key === 'P') togglePause();
        });

        // Touch / Mouse Drag
        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            if(!gameState.paused) player.x = e.touches[0].clientX;
        }, {passive: false});
        
        canvas.addEventListener('mousemove', e => {
            if (e.buttons === 1 && !gameState.paused) player.x = e.clientX;
        });

        // Tilt Control (Gyroscope)
        function handleOrientation(event) {
            if (!gameState.active || gameState.paused) return;
            // Gamma is left/right tilt (-90 to 90)
            const tilt = event.gamma; 
            if (tilt) {
                // Smoothing logic could be added here, but direct mapping feels responsive
                if (tilt > 5) player.x += player.speed * (tilt / 10);
                if (tilt < -5) player.x += player.speed * (tilt / 10);
            }
        }

        // --- Permission for iOS ---
        startBtn.addEventListener('click', () => {
            initAudio();
            
            // Check if permission is needed (iOS 13+)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        }
                        startGame();
                    })
                    .catch(console.error);
            } else {
                // Android or older iOS
                window.addEventListener('deviceorientation', handleOrientation);
                startGame();
            }
        });

        // Pause/Nuke Buttons
        pauseBtn.addEventListener('click', togglePause);
        nukeBtn.addEventListener('click', useNuke);

        function togglePause() {
            if (!gameState.active) return;
            gameState.paused = !gameState.paused;
            pauseScreen.style.display = gameState.paused ? 'block' : 'none';
            pauseBtn.innerText = gameState.paused ? '▶' : '⏸';
        }

        function useNuke() {
            if (gameState.active && !gameState.paused && gameState.nukes > 0) {
                gameState.nukes--;
                nukeCountEl.innerText = `(${gameState.nukes})`;
                playSound('nuke');
                gameState.shake = 20; // Big shake
                
                // Destroy all asteroids
                asteroids.forEach(a => {
                    createExplosion(a.x, a.y, a.color, 15);
                    scorePoints(20);
                });
                asteroids = [];
                
                // Flash screen
                ctx.fillStyle = 'white';
                ctx.fillRect(0,0,canvas.width, canvas.height);
            }
        }

        // --- Game Entities ---
        const player = {
            x: 0, y: 0, width: 50, height: 60, speed: 7,
            color: '#00ffff', maxHealth: 100, health: 100,
            powerUpType: 'none', powerUpTimer: 0,
            
            reset() {
                this.x = canvas.width / 2;
                this.y = canvas.height - 100;
                this.health = this.maxHealth;
                this.powerUpType = 'none';
                updateHealthUI();
            },

            update() {
                // Keyboard move
                if (keys['ArrowLeft'] || keys['a']) this.x -= this.speed;
                if (keys['ArrowRight'] || keys['d']) this.x += this.speed;

                // Boundaries
                if (this.x < this.width/2) this.x = this.width/2;
                if (this.x > canvas.width - this.width/2) this.x = canvas.width - this.width/2;

                // Powerup Timer
                if (this.powerUpTimer > 0) {
                    this.powerUpTimer--;
                    if (this.powerUpTimer <= 0) this.powerUpType = 'none';
                }

                this.draw();
            },

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);

                // Shield Effect
                if (this.powerUpType === 'shield') {
                    ctx.beginPath();
                    ctx.arc(0, 30, 45, 0, Math.PI*2);
                    ctx.strokeStyle = `rgba(0, 100, 255, ${Math.random() * 0.5 + 0.5})`;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }

                // Ship Body
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(-25, 60);
                ctx.lineTo(0, 45);
                ctx.lineTo(25, 60);
                ctx.closePath();
                ctx.fill();

                // Engine Flame
                if (!gameState.paused) {
                    ctx.fillStyle = `rgba(255, ${Math.random()*255}, 0, 0.8)`;
                    ctx.beginPath();
                    ctx.moveTo(-10, 50);
                    ctx.lineTo(0, 60 + Math.random() * 20);
                    ctx.lineTo(10, 50);
                    ctx.fill();
                }
                ctx.restore();
            }
        };

        let bullets = [];
        let asteroids = [];
        let particles = [];
        let powerups = [];

        class Bullet {
            constructor(x, y, angle = 0) {
                this.x = x; this.y = y;
                this.speed = 12;
                this.angle = angle;
                this.radius = 4;
                this.delete = false;
            }
            update() {
                this.x += Math.sin(this.angle) * this.speed;
                this.y -= Math.cos(this.angle) * this.speed;
                if (this.y < 0 || this.x < 0 || this.x > canvas.width) this.delete = true;
                
                ctx.fillStyle = '#ffff00';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                ctx.fill();
            }
        }

        class Asteroid {
            constructor() {
                this.radius = Math.random() * 25 + 15;
                this.x = Math.random() * (canvas.width - this.radius*2) + this.radius;
                this.y = -this.radius;
                // Speed increases with level
                this.speed = (Math.random() * 2 + 2) + (gameState.level * 0.5); 
                this.angle = 0;
                this.spin = Math.random() * 0.1 - 0.05;
                this.delete = false;
                this.color = `hsl(${Math.random()*60 + 200}, 20%, 50%)`; // Blue-ish rocks
                this.health = Math.floor(this.radius / 10); // Bigger rocks harder to kill
                
                // Shape
                this.points = [];
                const vertices = 6 + Math.floor(Math.random()*4);
                for(let i=0; i<vertices; i++) {
                    this.points.push(Math.random() * 10 - 5);
                }
            }
            update() {
                this.y += this.speed;
                this.angle += this.spin;
                if (this.y > canvas.height + 50) this.delete = true;

                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                const vertices = this.points.length;
                for(let i=0; i<vertices; i++) {
                    const theta = (i / vertices) * Math.PI * 2;
                    const r = this.radius + this.points[i];
                    const px = Math.cos(theta) * r;
                    const py = Math.sin(theta) * r;
                    if(i===0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                }
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }

        class PowerUp {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.speed = 3;
                this.type = Math.random() > 0.5 ? 'multi' : 'shield';
                this.radius = 15;
                this.delete = false;
            }
            update() {
                this.y += this.speed;
                if (this.y > canvas.height) this.delete = true;

                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.fillStyle = this.type === 'multi' ? '#00ff00' : '#0000ff';
                ctx.beginPath();
                ctx.arc(0, 0, this.radius, 0, Math.PI*2);
                ctx.fill();
                // Icon
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.type === 'multi' ? 'III' : 'S', 0, 0);
                
                // Glow
                ctx.shadowBlur = 10;
                ctx.shadowColor = ctx.fillStyle;
                ctx.stroke();
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = Math.random() * 6 - 3;
                this.vy = Math.random() * 6 - 3;
                this.life = 1.0;
                this.color = color;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= 0.03;
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 3, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        // --- Core Logic ---

        function updateHealthUI() {
            const pct = Math.max(0, (player.health / player.maxHealth) * 100);
            healthFill.style.width = pct + '%';
            if (pct < 30) healthFill.style.background = 'red';
            else healthFill.style.background = 'linear-gradient(90deg, #ff3333, #00ff00)';
        }

        function showNotification(text) {
            notificationEl.innerText = text;
            notificationEl.style.opacity = 1;
            setTimeout(() => notificationEl.style.opacity = 0, 1500);
        }

        function scorePoints(amt) {
            gameState.score += amt;
            scoreEl.innerText = gameState.score;
            
            // Level Up Check
            if (gameState.score > gameState.level * 1000) {
                gameState.level++;
                levelEl.innerText = gameState.level;
                player.health = player.maxHealth; // Heal on level up
                updateHealthUI();
                showNotification(`LEVEL ${gameState.level}`);
                playSound('powerup');
            }
        }

        function createExplosion(x, y, color, count=8) {
            for(let i=0; i<count; i++) particles.push(new Particle(x, y, color));
        }

        function shoot() {
            playSound('shoot');
            if (player.powerUpType === 'multi') {
                bullets.push(new Bullet(player.x, player.y));
                bullets.push(new Bullet(player.x, player.y, 0.2));
                bullets.push(new Bullet(player.x, player.y, -0.2));
            } else {
                bullets.push(new Bullet(player.x, player.y));
            }
        }

        function checkCollisions() {
            // Player vs Powerup
            powerups.forEach(p => {
                const dist = Math.hypot(player.x - p.x, player.y - p.y);
                if (dist < player.width/2 + p.radius) {
                    p.delete = true;
                    player.powerUpType = p.type;
                    player.powerUpTimer = 600; // 10 seconds approx
                    showNotification(p.type === 'multi' ? "TRIPLE SHOT!" : "SHIELD UP!");
                    playSound('powerup');
                }
            });

            asteroids.forEach(ast => {
                // Bullet vs Asteroid
                bullets.forEach(bul => {
                    const dist = Math.hypot(ast.x - bul.x, ast.y - bul.y);
                    if (dist < ast.radius + bul.radius) {
                        bul.delete = true;
                        createExplosion(ast.x, ast.y, '#ffff00', 3);
                        ast.health--;
                        if (ast.health <= 0) {
                            ast.delete = true;
                            createExplosion(ast.x, ast.y, ast.color, 10);
                            scorePoints(10 + (gameState.level * 2));
                            playSound('explosion');
                            gameState.shake = 5; // Small shake
                            
                            // Chance for Powerup (10%)
                            if (Math.random() < 0.1) powerups.push(new PowerUp(ast.x, ast.y));
                        }
                    }
                });

                // Player vs Asteroid
                const distPlayer = Math.hypot(player.x - ast.x, player.y - ast.y + 20);
                if (distPlayer < player.width/2 + ast.radius) {
                    ast.delete = true;
                    createExplosion(ast.x, ast.y, 'orange', 15);
                    gameState.shake = 15;
                    playSound('explosion');

                    if (player.powerUpType === 'shield') {
                        player.powerUpType = 'none'; // Shield breaks
                        showNotification("SHIELD BROKEN!");
                    } else {
                        player.health -= 20;
                        updateHealthUI();
                        if (player.health <= 0) endGame();
                    }
                }
            });
        }

        // --- Loop ---
        function animate() {
            if (!gameState.active) return;
            requestAnimationFrame(animate);
            if (gameState.paused) return;

            // Screen Shake Logic
            if (gameState.shake > 0) {
                const dx = Math.random() * gameState.shake - gameState.shake/2;
                const dy = Math.random() * gameState.shake - gameState.shake/2;
                ctx.translate(dx, dy);
                gameState.shake *= 0.9; // Decay
                if(gameState.shake < 0.5) gameState.shake = 0;
            } else {
                ctx.setTransform(1,0,0,1,0,0);
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Stars
            ctx.fillStyle = 'white';
            stars.forEach(s => {
                ctx.globalAlpha = Math.random();
                ctx.fillRect(s.x, s.y, s.size, s.size);
                s.y += s.speed;
                if (s.y > canvas.height) s.y = 0;
            });
            ctx.globalAlpha = 1;

            player.update();
            
            // Auto Shoot (Mobile logic adapted for all for ease)
            if (gameState.frameCount % 15 === 0) shoot();

            // Spawners
            // Asteroids
            let spawnRate = Math.max(20, 60 - gameState.level * 5);
            if (gameState.frameCount % spawnRate === 0) asteroids.push(new Asteroid());

            // Updates
            bullets = bullets.filter(b => !b.delete);
            bullets.forEach(b => b.update());

            asteroids = asteroids.filter(a => !a.delete);
            asteroids.forEach(a => a.update());

            powerups = powerups.filter(p => !p.delete);
            powerups.forEach(p => p.update());

            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => p.update());

            checkCollisions();
            gameState.frameCount++;
        }

        // Background Stars
        const stars = Array(100).fill().map(() => ({
            x: Math.random() * window.innerWidth,
            y: Math.random() * window.innerHeight,
            size: Math.random() * 2,
            speed: Math.random() * 2 + 0.5
        }));

        function startGame() {
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            gameState.active = true;
            gameState.score = 0;
            gameState.level = 1;
            gameState.nukes = 3;
            gameState.paused = false;
            
            scoreEl.innerText = '0';
            levelEl.innerText = '1';
            nukeCountEl.innerText = '(3)';
            
            asteroids = [];
            bullets = [];
            powerups = [];
            player.reset();
            animate();
        }

        function endGame() {
            gameState.active = false;
            document.getElementById('final-score').innerText = gameState.score;
            
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('khushShooterHighScore', gameState.highScore);
                hiScoreEl.innerText = gameState.highScore;
            }
            
            gameOverScreen.style.display = 'block';
        }

        function resetGame() {
            startGame();
        }
    </script>
</body>
</html>