<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vanshawali | Thikana Kasumbi (Jakhlan)</title>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Serif+Devanagari:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){ emailjs.init("KpyNvZBBeX0ZJisG8"); })(); /* New Key Updated */
    </script>

    <link rel="stylesheet" href="royal_global.css">

    <style>
        /* =========================================
           1. CORE LAYOUT
           ========================================= */
        body { overflow-x: hidden; background: #fffbf0; }
        
        /* Tooltip (Desktop Only) */
        #hoverTooltip {
            position: fixed; display: none; background: rgba(0,0,0,0.95); color: #fff;
            padding: 10px; border-radius: 4px; font-size: 12px; z-index: 20000; pointer-events: none;
            border: 1px solid #d4af37; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            font-family: 'Merriweather', serif; max-width: 250px;
        }

        /* =========================================
           2. TREE CONTAINER (Ultra Compact & Colorful)
           ========================================= */
        .tree-container {
            background: #fffbf0;
            padding: 50px 10px;
            min-height: 800px;
            font-family: 'Noto Serif Devanagari', serif;
            overflow: auto; cursor: grab;
        }
        .tree-container:active { cursor: grabbing; }

        .royal-tree ul {
            padding-left: 20px; /* Compact Indent */
            list-style: none; position: relative; transition: all 0.3s ease;
        }

        .royal-tree li {
            position: relative; padding-left: 15px; margin-bottom: 0;
            line-height: 1.5em; /* Ultra Compact Height */
        }

        /* L-Shape Lines */
        .royal-tree ul li::before {
            content: ''; position: absolute; left: 0; top: 0;
            border-left-width: 2px; border-left-style: solid; height: 100%;
        }
        .royal-tree ul li::after {
            content: ''; position: absolute; left: 0; top: 0.75em; 
            width: 12px; border-top-width: 2px; border-top-style: solid;
        }
        .royal-tree ul li:last-child::before { height: 0.75em; }

        /* --- 12 GENERATION COLORS --- */
        .gen-1 > ul > li::before, .gen-1 > ul > li::after { border-color: #800000; } /* Maroon */
        .gen-2 > ul > li::before, .gen-2 > ul > li::after { border-color: #d63031; } /* Red */
        .gen-3 > ul > li::before, .gen-3 > ul > li::after { border-color: #0984e3; } /* Blue */
        .gen-4 > ul > li::before, .gen-4 > ul > li::after { border-color: #00b894; } /* Green */
        .gen-5 > ul > li::before, .gen-5 > ul > li::after { border-color: #6c5ce7; } /* Purple */
        .gen-6 > ul > li::before, .gen-6 > ul > li::after { border-color: #e17055; } /* Orange */
        .gen-7 > ul > li::before, .gen-7 > ul > li::after { border-color: #00cec9; } /* Teal */
        .gen-8 > ul > li::before, .gen-8 > ul > li::after { border-color: #e84393; } /* Pink */
        .gen-9 > ul > li::before, .gen-9 > ul > li::after { border-color: #2d3436; } /* Grey */
        .gen-10 > ul > li::before, .gen-10 > ul > li::after { border-color: #fdcb6e; } /* Mustard */
        .gen-11 > ul > li::before, .gen-11 > ul > li::after { border-color: #636e72; } /* Slate */
        .gen-12 > ul > li::before, .gen-12 > ul > li::after { border-color: #d4af37; } /* Gold */

        /* Name Styling */
        .tree-name {
            font-size: 14px; color: #5a4a42; font-weight: bold;
            padding: 1px 6px; border-radius: 4px; transition: 0.2s;
            display: inline-block; cursor: pointer; border: 1px solid transparent;
        }
        .has-children > .tree-name-wrapper .tree-name { color: #800000; font-weight: 900; }
        
        .tree-name:hover, .highlight-node {
            background: #b8860b; color: #fff !important;
            border-color: #800000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* BIG Toggle Button (+/-) */
        .toggle-btn {
            display: inline-block; 
            width: 20px; height: 20px; /* Increased Size */
            border: 1px solid #800000; background: #fff;
            color: #800000; font-size: 14px; line-height: 18px;
            text-align: center; margin-right: 5px; cursor: pointer;
            border-radius: 3px; position: relative; z-index: 10;
            vertical-align: middle;
        }
        .toggle-btn:hover { background: #800000; color: #fff; }

        /* Root Node Styling */
        .root-ul { padding-left: 0 !important; }
        .root-li { padding-left: 0 !important; }
        .root-li::before, .root-li::after { display: none !important; }
        .root-name {
            font-family: 'Cinzel', serif; font-size: 22px; color: #800000;
            border-bottom: 3px solid #d4af37; padding-bottom: 5px;
            margin-bottom: 15px; display: inline-block; cursor: pointer;
        }

        .children-group { display: none; } /* Default Collapsed */

        /* =========================================
           3. PANELS (Fixed & Mobile Proof)
           ========================================= */
        .sidebar-left, .sidebar-right {
            position: fixed; top: 0; bottom: 0; 
            width: 320px; background: #fffbf0;
            border: 2px solid #d4af37;
            box-shadow: 0 0 25px rgba(0,0,0,0.7);
            z-index: 10001; /* Above everything */
            transition: transform 0.3s ease;
            display: flex; flex-direction: column;
            padding-top: 50px;
        }

        @media (min-width: 769px) {
            .sidebar-left { left: 0; transform: translateX(-100%); top: 52px; }
            .sidebar-right { right: 0; transform: translateX(100%); top: 52px; }
            .sidebar-left.open, .sidebar-right.open { transform: translateX(0); }
        }

        @media (max-width: 768px) {
            .sidebar-left, .sidebar-right { width: 90%; max-width: 350px; top: 0; bottom: 0; }
            .sidebar-left { left: 0; transform: translateX(-110%); }
            .sidebar-right { right: 0; transform: translateX(110%); }
            .sidebar-left.open, .sidebar-right.open { transform: translateX(0); }
        }

        .panel-header {
            background: #800000; color: #d4af37; padding: 12px;
            font-family: 'Cinzel', serif; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #d4af37;
        }
        
        .panel-content { flex-grow: 1; overflow-y: auto; padding: 15px; }

        /* Search & List */
        .search-container { position: relative; width: 95%; margin: 10px auto; }
        .search-box-panel {
            width: 100%; padding: 10px 35px 10px 10px;
            border: 2px solid #d4af37; border-radius: 4px;
            font-family: 'Noto Serif Devanagari'; font-size: 16px;
        }
        .clear-search {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            cursor: pointer; color: #800000; font-size: 18px; display: none;
        }
        .index-list li { padding: 10px; border-bottom: 1px solid #ebd5a0; cursor: pointer; }
        .index-list li:hover { background: #f0e6c8; color: #800000; }

        /* Ancestral Path */
        .path-node {
            padding-left: 25px; border-left: 3px solid #d4af37;
            position: relative; margin-bottom: 0; padding-bottom: 15px;
            font-family: 'Merriweather', serif; font-size: 13px; color: #333;
        }
        .path-node::before {
            content: ''; position: absolute; left: -6px; top: 5px;
            width: 9px; height: 9px; background: #800000; border-radius: 50%; border: 1px solid #fff;
        }
        .path-node:last-child { border-left: none; }

        /* =========================================
           4. SMART TOOLS (Mobile Optimized)
           ========================================= */
        .fab-container {
            position: fixed; bottom: 30px; right: 20px; z-index: 10002;
            display: flex; flex-direction: column-reverse; align-items: center; gap: 10px;
        }

        /* Default Sizes (Desktop) */
        .main-fab {
            width: 55px; height: 55px; border-radius: 50%; background: #800000; color: #d4af37;
            border: 2px solid #d4af37; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s;
        }
        .main-fab.active { transform: rotate(45deg); }
        .fab-options {
            display: flex; flex-direction: column-reverse; gap: 10px;
            opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s;
        }
        .fab-options.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .mini-fab {
            width: 45px; height: 45px; border-radius: 50%; background: #fff; color: #333;
            border: 2px solid #d4af37; cursor: pointer; font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        }

        /* Mobile Small Buttons Fix */
        @media (max-width: 768px) {
            .main-fab { width: 45px; height: 45px; font-size: 20px; bottom: 20px; right: 15px; }
            .mini-fab { width: 38px; height: 38px; font-size: 14px; }
            .fab-container { bottom: 20px; right: 15px; }
        }

        /* Mobile Search Icon Position */
        .mobile-search-btn {
            position: absolute; top: 10px; right: 60px; /* Near Logo/Toggle */
            font-size: 18px; color: #d4af37; cursor: pointer; padding: 5px;
            display: none;
        }
        @media (max-width: 768px) { .mobile-search-btn { display: block; } }

        /* =========================================
           5. MODAL & MISC
           ========================================= */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 20000;
        }
        .modal-box {
            background: #fffbf0; border: 3px solid #d4af37; width: 90%; max-width: 400px;
            margin: 20% auto; padding: 25px; border-radius: 10px; position: relative;
        }
        .modal-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #d4af37; border-radius: 4px; }
        .gold-btn {
            background: #800000; color: #d4af37; border: 1px solid #d4af37;
            padding: 8px 15px; font-weight: bold; cursor: pointer; width: 100%;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="navbar-wrapper">
        <div class="container">
            <nav class="navbar navbar-inverse">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
                        <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
                    </button>
                    <div class="mobile-search-btn" onclick="toggleLeftPanel()">
                        <i class="fas fa-search"></i>
                    </div>
                    <a class="navbar-brand" href="index.html">
                        <img src="menulogo.png" alt="Logo" class="menu-logo-img"> KASUMALGARH
                    </a>
                </div>
                <div id="navbar" class="collapse navbar-collapse">
                   <ul class="nav navbar-nav navbar-right">
                        <li><a href="index.html">HOME</a></li>
                        <li class="dropdown active">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">VANSHAWALI <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="vanshawali.html">Kasumalgarh</a></li>
                                <li><a href="rathorevanshawali.html">Rathore</a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">HISTORY <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="kasumalgarh.html">Kasumalgarh History</a></li>
                                <li><a href="rathore.html">Rathore History</a></li>
                            </ul>
                        </li>
                        <li><a href="gallery.html">GALLERY</a></li>
                        <li><a href="contact.html">CONTACT</a></li>
                        <li class="hidden-xs"><a href="#" onclick="toggleLeftPanel()"><i class="fas fa-search"></i> Search</a></li>
                        <li><a href="#" onclick="openRequestModal()"><i class="fas fa-user-plus"></i> Add</a></li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>

    <header class="index-header" style="min-height: 250px; padding-top: 100px; background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('fort_kasumbi.png');">
        <div class="container">
            <h1 class="shining-text" style="font-size: 2.5em;">|| वंशावली ||</h1>
            <div style="font-family: 'Cinzel'; color: #d4af37; letter-spacing: 2px; text-transform: uppercase;">
                Thikana Kasumbi (Jakhlan)
            </div>
        </div>
    </header>

    <div class="tree-container" id="treeWrapper">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div id="treeArea" style="display: inline-block; min-width: 100%; transform-origin: top left; transition: transform 0.3s;">
                        <div class="royal-tree" id="royalTreeArea">
                            <div style="text-align: center; color: #888;">
                                <i class="fas fa-spinner fa-spin"></i> Loading Royal Lineage...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <aside class="sidebar-left" id="leftPanel">
        <div class="panel-header">
            <span><i class="fas fa-list"></i> Member Index</span>
            <i class="fas fa-times" onclick="toggleLeftPanel()" style="cursor:pointer; font-size:20px;"></i>
        </div>
        <div class="search-container">
            <input type="text" id="searchBox" class="search-box-panel" placeholder="नाम खोजें..." onkeyup="filterIndex()">
            <i class="fas fa-times clear-search" id="clearSearchBtn" onclick="clearSearch()"></i>
        </div>
        <div class="panel-content">
            <ul class="index-list" id="indexList"></ul>
        </div>
    </aside>

    <aside class="sidebar-right" id="rightPanel">
        <div class="panel-header">
            <span><i class="fas fa-info-circle"></i> Family Details</span>
            <i class="fas fa-times" onclick="closeRightPanel()" style="cursor:pointer; font-size:20px;"></i>
        </div>
        <div class="panel-content" id="captureTarget" style="background: #fffbf0; position:relative;">
            
            <div id="memberDetails" style="text-align: center; margin-bottom: 20px;"></div>
            
            <h5 style="color:#800000; font-family:'Cinzel'; border-bottom: 1px dashed #d4af37; padding-bottom: 5px;">Ancestral Path (वंशावली क्रम)</h5>
            <div id="ancestralPath" style="margin-top: 15px;"></div>

            <div style="margin-top:30px; font-size:10px; color:#999; text-align:center; border-top:1px solid #ebd5a0; padding-top:10px;">
                Generated by Kasumalgarh.site
            </div>
        </div>
    </aside>

    <div id="hoverTooltip"></div>

    <div class="fab-container">
        <div class="main-fab" onclick="toggleFab(this)">
            <i class="fas fa-plus"></i>
        </div>
        <div class="fab-options" id="fabOptions">
            <button class="mini-fab" onclick="resetTree()" title="Reset Tree"><i class="fas fa-sync-alt"></i></button>
            <button class="mini-fab" onclick="zoomIn()" title="Zoom In"><i class="fas fa-plus"></i></button>
            <button class="mini-fab" onclick="zoomOut()" title="Zoom Out"><i class="fas fa-minus"></i></button>
            <button class="mini-fab" onclick="captureRightPanel()" title="Download Full HD" style="background:#2ecc71; color:#fff; border-color:#27ae60;"><i class="fas fa-camera"></i></button>
        </div>
    </div>

    <div id="requestModal" class="modal-overlay">
        <div class="modal-box">
            <span onclick="closeRequestModal()" style="position:absolute; right:15px; top:10px; font-size:24px; cursor:pointer; color:#800000;">&times;</span>
            <h4 style="color:#800000; text-align:center; font-family:'Cinzel';">Request Correction</h4>
            <input type="text" id="reqName" class="modal-input" placeholder="Your Name">
            <textarea id="reqMsg" class="modal-input" rows="4" placeholder="Details..."></textarea>
            <button onclick="sendRequest()" class="gold-btn">Send Request</button>
        </div>
    </div>

    <footer class="royal-footer">
        <div class="container">
            <div style="color:#7A5D28; font-size:1.2rem; font-family: 'Cinzel', serif; margin: 5px 0;">Yuvraj Gajraj Singh</div>
            <div style="font-size: 0.8em; margin-top: 10px; color: #888;">&copy; <span id="year">2026</span></div>
        </div>
    </footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="royal_global.js"></script>
    <script src="family-data.js"></script>

    <script>
        let allMembers = [];
        let currentZoom = 1;
        let isRightPanelOpen = false;
        let rootNodeName = "";

        // --- 1. TREE GENERATION ---
        function generateTreeHTML(member, isRoot, depth) {
            if (!member) return '';
            if(isRoot) rootNodeName = member.name;

            let uniqueId = "node-" + Math.floor(Math.random() * 10000000);
            allMembers.push({ name: member.name, id: uniqueId, depth: depth, data: member });

            let hasChild = (member.children && member.children.length > 0);
            let liClass = isRoot ? 'root-li gen-1' : (hasChild ? `has-children gen-${depth}` : `gen-${depth}`);
            let nameClass = isRoot ? 'root-name' : 'tree-name';
            
            // Collapsed Logic: Root open, others closed
            let toggleBtn = '';
            let ulStyle = 'style="display:none;"'; 
            let btnSymbol = '+';

            if(isRoot) { ulStyle = ''; } // Root UL visible, but its children UL (L2) hidden by logic below
            
            // Create Toggle Button
            if(hasChild) {
                toggleBtn = `<span class="toggle-btn" onclick="toggleBranch(this)">${btnSymbol}</span>`;
            }

            let html = `<li class="${liClass}" id="li-${uniqueId}">`;
            
            html += `<div class="tree-name-wrapper">
                        ${!isRoot ? toggleBtn : ''}
                        <span class="${nameClass}" id="${uniqueId}" 
                              onclick="showDetails('${uniqueId}', event)"
                              onmouseenter="showTooltip('${uniqueId}', event)"
                              onmouseleave="hideTooltip()">
                            ${member.name}
                        </span>
                     </div>`;

            if (hasChild) {
                let ulClass = isRoot ? 'root-ul' : 'children-group';
                // Root's immediate children are visible, deep children hidden?
                // User said "suru me page khule jb vanshawali band ho + kane par khule".
                // So everything collapsed except root name.
                if(isRoot) ulStyle = 'style="display:none;"'; 
                
                html += `<ul class="${ulClass}" ${ulStyle}>`;
                member.children.forEach(function(child) {
                    html += generateTreeHTML(child, false, depth + 1);
                });
                html += '</ul>';
                
                // Root Toggle Button (Manual Insert for visual consistency if needed)
                if(isRoot) {
                    // Inject toggle for root via JS after load or handle above
                    // Simplified: Root name click expands? Or Add toggle to root too.
                    // Let's add toggle to root wrapper above.
                    html = html.replace(`${!isRoot ? toggleBtn : ''}`, `<span class="toggle-btn" onclick="toggleBranch(this)">+</span>`);
                }
            }
            html += '</li>';
            return html;
        }

        // --- 2. LOGIC ---
        function toggleBranch(btn) {
            let ul = $(btn).closest('li').children('ul');
            if(ul.is(':visible')) {
                ul.slideUp(); $(btn).text('+');
            } else {
                ul.slideDown(); $(btn).text('-');
            }
        }

        $(document).ready(function() {
            if (typeof familyData !== 'undefined') {
                allMembers = [];
                let treeHTML = '<ul class="root-ul">' + generateTreeHTML(familyData, true, 1) + '</ul>';
                $('#royalTreeArea').html(treeHTML);
                populateIndex();
                $('#totalCount').text(allMembers.length);
            }
        });

        // --- 3. DATA CALCULATION (Updated Text Format) ---
        function getMemberInfo(id) {
            let el = $('#' + id);
            let memberObj = allMembers.find(m => m.id === id);
            
            // Path
            let pathArray = [];
            el.parents('li').each(function() {
                let span = $(this).find('> .tree-name-wrapper > span');
                if(span.length > 0) pathArray.push(span.text().trim());
            });
            // Father (Parent Node)
            let fatherName = pathArray.length > 1 ? pathArray[1] : "Founder";

            // Siblings
            let parentLi = el.closest('ul').parent('li');
            let siblings = [];
            let myIndex = 1;
            
            if(parentLi.length) {
                let allSibsLI = parentLi.find('> ul > li');
                allSibsLI.each(function(idx) {
                    if($(this).attr('id') !== el.closest('li').attr('id')) {
                        let sibName = $(this).find('> .tree-name-wrapper > span').text().trim();
                        siblings.push(sibName);
                    } else {
                        myIndex = idx + 1;
                    }
                });
            }

            // Ordinal & Type
            let suffix = (myIndex === 1) ? 'st' : (myIndex === 2) ? 'nd' : (myIndex === 3) ? 'rd' : 'th';
            let nameLower = memberObj.name.toLowerCase();
            let childType = (nameLower.includes('baisa') || nameLower.includes('bai')) ? "Daughter" : "Son";
            
            let relationText = (siblings.length + 1 === 1) ? `Only ${childType}` : `${myIndex}${suffix} ${childType}`;
            let siblingText = siblings.length > 0 ? `He has ${siblings.length} more siblings` : `Only Child`;
            let sibNamesStr = siblings.length > 0 ? `(${siblings.join(', ')})` : "";

            return {
                name: memberObj.name,
                father: fatherName,
                relation: relationText,
                siblingsDesc: siblingText,
                sibNames: sibNamesStr,
                gen: `${memberObj.depth}th Gen of ${rootNodeName}`,
                path: pathArray.reverse()
            };
        }

        // --- 4. DETAILS PANEL ---
        function showDetails(id, e) {
            e.stopPropagation();
            $('.highlight-node').removeClass('highlight-node');
            $('#' + id).addClass('highlight-node');

            let info = getMemberInfo(id);

            let detailsHTML = `
                <h3 style="color:#800000; font-family:'Cinzel'; margin-top:0;">${info.name}</h3>
                <div style="background:#fffbe6; padding:15px; border:1px solid #d4af37; border-radius:5px; font-family:'Merriweather'; font-size:13px; line-height:1.8;">
                    <strong>${info.relation}</strong> of <strong>${info.father}</strong><br>
                    <span style="color:#555;">${info.siblingsDesc} ${info.sibNames}</span><br>
                    <span style="color:#800000; font-weight:bold;">${info.gen}.</span>
                </div>
            `;
            $('#memberDetails').html(detailsHTML);

            let pathHTML = '';
            info.path.forEach((name, idx) => {
                let isLast = idx === info.path.length - 1;
                let style = isLast ? "color:#800000; font-weight:bold; background:#fff0d0; padding:2px 5px; border-radius:3px;" : "";
                pathHTML += `<div class="path-node"><span style="${style}">${name}</span></div>`;
            });
            $('#ancestralPath').html(pathHTML);

            $('#rightPanel').addClass('open');
            $('#leftPanel').removeClass('open');
            isRightPanelOpen = true;
        }

        function showTooltip(id, e) {
            if(window.innerWidth < 768) return;
            let info = getMemberInfo(id);
            let tooltip = $('#hoverTooltip');
            tooltip.html(`<strong style="color:#d4af37">${info.name}</strong><br>${info.relation} of ${info.father}<br>${info.gen}`);
            tooltip.css({top: e.clientY + 15, left: e.clientX + 15}).show();
        }
        function hideTooltip() { $('#hoverTooltip').hide(); }

        // --- 5. FULL HEIGHT SCREENSHOT (Cloning Method) ---
        function captureRightPanel() {
            if(!isRightPanelOpen) { alert("Please select a member first."); return; }
            let btn = $('.mini-fab[title="Download Full HD"] i');
            btn.attr('class', 'fas fa-spinner fa-spin');

            let original = document.getElementById("captureTarget");
            // Clone to capture full height even if scrollable
            let clone = original.cloneNode(true);
            
            // Set styles to make clone fully visible off-screen
            clone.style.width = "320px";
            clone.style.height = "auto";
            clone.style.maxHeight = "none";
            clone.style.overflow = "visible";
            clone.style.position = "absolute";
            clone.style.top = "-10000px";
            clone.style.left = "0";
            clone.style.background = "#fffbf0";
            clone.style.zIndex = "5000";
            document.body.appendChild(clone);

            html2canvas(clone, { scale: 4, backgroundColor: "#fffbf0" }).then(canvas => {
                let link = document.createElement('a');
                link.download = 'Ancestral-Path-HD.png';
                link.href = canvas.toDataURL();
                link.click();
                document.body.removeChild(clone); // Cleanup
                btn.attr('class', 'fas fa-camera');
            }).catch(err => {
                alert("Error: " + err);
                if(document.body.contains(clone)) document.body.removeChild(clone);
                btn.attr('class', 'fas fa-camera');
            });
        }

        // --- 6. UTILS ---
        function toggleLeftPanel() { $('#leftPanel').toggleClass('open'); closeRightPanel(); }
        function closeRightPanel() { $('#rightPanel').removeClass('open'); isRightPanelOpen = false; }
        function toggleFab(btn) { $(btn).toggleClass('active'); $('#fabOptions').toggleClass('show'); }
        function zoomIn() { if(currentZoom < 3) currentZoom += 0.1; $('#treeArea').css('transform', `scale(${currentZoom})`); }
        function zoomOut() { if(currentZoom > 0.3) currentZoom -= 0.1; $('#treeArea').css('transform', `scale(${currentZoom})`); }
        function resetTree() { $('.children-group').slideUp(); $('.toggle-btn').text('+'); currentZoom = 1; $('#treeArea').css('transform', `scale(1)`); closeRightPanel(); }
        
        // Auto Close
        $(document).click(function(event) { 
            if(!$(event.target).closest('#rightPanel, .tree-name, .toggle-btn, .fab-container').length && $('#rightPanel').hasClass('open')) closeRightPanel();
            if(!$(event.target).closest('#leftPanel, .navbar-nav, .mobile-search-btn').length && $('#leftPanel').hasClass('open')) $('#leftPanel').removeClass('open');
        });

        // Search
        function populateIndex() {
            let list = $('#indexList'); list.empty();
            [...allMembers].sort((a,b)=>a.name.localeCompare(b.name)).forEach(m => list.append(`<li onclick="jumpToNode('${m.id}')">${m.name}</li>`));
        }
        function filterIndex() {
            let val = $('#searchBox').val().toLowerCase(); $('#clearSearchBtn').toggle(val.length > 0);
            $('#indexList li').toggle(function() { return $(this).text().toLowerCase().indexOf(val) > -1; });
        }
        function clearSearch() { $('#searchBox').val(''); filterIndex(); }
        function jumpToNode(id) {
            toggleLeftPanel();
            let el = document.getElementById(id);
            $(el).parents('ul').slideDown();
            $(el).parents('li').children('.tree-name-wrapper').find('.toggle-btn').text('-');
            setTimeout(() => { el.scrollIntoView({behavior: "smooth", block: "center"}); el.click(); }, 300);
        }
        
        function openRequestModal() { $('#requestModal').fadeIn(); }
        function closeRequestModal() { $('#requestModal').fadeOut(); }
        function sendRequest() {
            let n = $('#reqName').val(), m = $('#reqMsg').val();
            if(!n || !m) { alert("Fill all fields"); return; }
            emailjs.send("service_vdnox8p", "template_xx3a4tt", { from_name: n, message: m }).then(()=>{ alert("Sent!"); closeRequestModal(); });
        }
    </script>
</body>
</html>
