<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vanshawali | Thikana Kasumbi (Jakhlan)</title>
    <link rel="icon" href="YGSR.png" type="image/png">
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Serif+Devanagari:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){ emailjs.init("KpyNvZBBeX0ZJisG8"); })();
    </script>

    <link rel="stylesheet" href="royal_global.css">

    <style>
        /* =========================================
           1. CORE LAYOUT & WATERMARK
           ========================================= */
        body { 
            overflow-x: hidden; background: #fffbf0; 
            -webkit-tap-highlight-color: transparent; 
            position: relative;
        }

        /* Site Watermark (Fixed Background) */
        body::before {
            content: ''; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 60%; height: 60%;
            background: url('klogo1.png') no-repeat center center;
            background-size: contain; opacity: 0.05; z-index: -1;
            pointer-events: none;
        }

        /* Loading Animation (Breathing Logo) */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fffbf0; z-index: 50000; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .breathing-logo {
            width: 100px; animation: breathe 2s infinite ease-in-out;
            margin-bottom: 20px;
        }
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }

        /* =========================================
           2. TREE DESIGN (Compact & Royal)
           ========================================= */
        .tree-container {
            padding: 50px 10px; min-height: 800px;
            font-family: 'Noto Serif Devanagari', serif;
            overflow: auto; cursor: grab; user-select: none;
            opacity: 0; transition: opacity 1s ease-in; /* Fade In Effect */
        }
        .tree-container.loaded { opacity: 1; }
        .tree-container:active { cursor: grabbing; }

        .royal-tree ul { padding-left: 20px; list-style: none; position: relative; }
        .royal-tree li { position: relative; padding-left: 15px; line-height: 1.5em; }

        /* Lines */
        .royal-tree ul li::before { content: ''; position: absolute; left: 0; top: 0; border-left-width: 2px; border-left-style: solid; height: 100%; transition: border-color 0.3s; }
        .royal-tree ul li::after { content: ''; position: absolute; left: 0; top: 0.75em; width: 12px; border-top-width: 2px; border-top-style: solid; transition: border-color 0.3s; }
        .royal-tree ul li:last-child::before { height: 0.75em; }

        /* 12 Generation Colors */
        .gen-1 > ul > li::before, .gen-1 > ul > li::after { border-color: #800000; }
        .gen-2 > ul > li::before, .gen-2 > ul > li::after { border-color: #d63031; }
        .gen-3 > ul > li::before, .gen-3 > ul > li::after { border-color: #0984e3; }
        .gen-4 > ul > li::before, .gen-4 > ul > li::after { border-color: #00b894; }
        .gen-5 > ul > li::before, .gen-5 > ul > li::after { border-color: #6c5ce7; }
        .gen-6 > ul > li::before, .gen-6 > ul > li::after { border-color: #e17055; }
        .gen-7 > ul > li::before, .gen-7 > ul > li::after { border-color: #00cec9; }
        .gen-8 > ul > li::before, .gen-8 > ul > li::after { border-color: #e84393; }
        .gen-9 > ul > li::before, .gen-9 > ul > li::after { border-color: #2d3436; }
        .gen-10 > ul > li::before, .gen-10 > ul > li::after { border-color: #fdcb6e; }
        .gen-11 > ul > li::before, .gen-11 > ul > li::after { border-color: #636e72; }
        .gen-12 > ul > li::before, .gen-12 > ul > li::after { border-color: #d4af37; }

        /* GOLDEN PATH HIGHLIGHT (The Main Lineage Feature) */
        li.is-ancestor > ul > li::before, li.is-ancestor > ul > li::after { border-color: #FFD700 !important; border-width: 3px !important; box-shadow: 0 0 5px #FFD700; }
        li.is-ancestor > .tree-name-wrapper > .tree-name { 
            background: #fff5e6; border: 1px solid #FFD700; color: #800000 !important; font-weight: 900;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }

        /* Name Wrapper (Mobile Fix) */
        .tree-name-wrapper {
            display: flex; align-items: center; gap: 5px; padding: 2px 0;
            flex-wrap: wrap; /* Allows wrapping on small screens */
        }

        .tree-name {
            font-size: 14px; color: #5a4a42; font-weight: bold;
            padding: 2px 6px; border-radius: 4px; transition: 0.2s;
            cursor: pointer; border: 1px solid transparent;
            white-space: normal; /* Allow text wrap */
            max-width: 100%; /* Prevent overflow */
        }
        
        /* Hint (Mobile optimized) */
        .click-hint {
            font-size: 11px; color: #d63031; font-weight: bold;
            animation: bounce 1.5s infinite; white-space: nowrap;
        }
        @media (max-width: 768px) {
            .click-hint { 
                flex-basis: 100%; /* Force new line on mobile */
                margin-left: 30px; /* Indent below name */
                margin-top: -2px;
            }
        }
        @keyframes bounce { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(3px); } }

        .toggle-btn {
            display: flex; align-items: center; justify-content: center;
            width: 24px; height: 24px; border: 1px solid #800000; background: #fff;
            color: #800000; font-size: 16px; cursor: pointer; border-radius: 4px; z-index: 10;
            flex-shrink: 0;
        }
        .toggle-btn:hover { background: #800000; color: #fff; }

        .root-name {
            font-family: 'Cinzel', serif; font-size: 22px; color: #800000;
            border-bottom: 3px solid #d4af37; padding-bottom: 5px;
            margin-bottom: 10px; display: inline-block; cursor: pointer;
        }

        .children-group { display: none; }

        /* =========================================
           3. PANELS & GENERATION SEAL
           ========================================= */
        .sidebar-left, .sidebar-right {
            position: fixed; top: 0; bottom: 0; width: 320px; background: #fffbf0;
            border: 2px solid #d4af37; box-shadow: 0 0 25px rgba(0,0,0,0.7);
            z-index: 10001; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; padding-top: 50px;
        }
        @media (min-width: 769px) {
            .sidebar-left { left: 0; transform: translateX(-100%); top: 52px; }
            .sidebar-right { right: 0; transform: translateX(100%); top: 52px; }
            .sidebar-left.open, .sidebar-right.open { transform: translateX(0); }
        }
        @media (max-width: 768px) {
            .sidebar-left, .sidebar-right { width: 90%; max-width: 350px; }
            .sidebar-left { left: 0; transform: translateX(-110%); }
            .sidebar-right { right: 0; transform: translateX(110%); }
            .sidebar-left.open, .sidebar-right.open { transform: translateX(0); }
        }

        .panel-header { background: #800000; color: #d4af37; padding: 12px; font-family: 'Cinzel', serif; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #d4af37; }
        .panel-content { flex-grow: 1; overflow-y: auto; padding: 15px; }

        /* Generation Seal (Royal Coin Style) */
        .gen-seal {
            width: 40px; height: 40px; border-radius: 50%;
            background: radial-gradient(circle, #ffd700 0%, #daa520 100%);
            border: 2px solid #800000; color: #800000;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: 'Cinzel'; margin: 0 auto 5px auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .gen-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* Search */
        .search-container { position: relative; width: 95%; margin: 10px auto; }
        .search-box-panel { width: 100%; padding: 10px 35px 10px 10px; border: 2px solid #d4af37; border-radius: 4px; font-family: 'Noto Serif Devanagari'; font-size: 16px; }
        .clear-search { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #800000; font-size: 18px; display: none; }
        .index-list li { padding: 10px; border-bottom: 1px solid #ebd5a0; cursor: pointer; }

        /* Path */
        .path-node { padding-left: 25px; border-left: 3px solid #d4af37; position: relative; padding-bottom: 15px; font-family: 'Merriweather', serif; font-size: 13px; color: #333; }
        .path-node::before { content: ''; position: absolute; left: -6px; top: 5px; width: 9px; height: 9px; background: #800000; border-radius: 50%; border: 1px solid #fff; }
        .path-node:last-child { border-left: none; }

        /* =========================================
           4. SMART TOOLS & WHATSAPP
           ========================================= */
        .fab-container { position: fixed; bottom: 30px; right: 20px; z-index: 10002; display: flex; flex-direction: column-reverse; align-items: center; gap: 10px; }
        .main-fab { width: 55px; height: 55px; border-radius: 50%; background: #800000; color: #d4af37; border: 2px solid #d4af37; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; transition: transform 0.3s; }
        .main-fab.active { transform: rotate(45deg); }
        .fab-options { display: flex; flex-direction: column-reverse; gap: 10px; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s; }
        .fab-options.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .mini-fab { width: 45px; height: 45px; border-radius: 50%; background: #fff; color: #333; border: 2px solid #d4af37; cursor: pointer; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
        
        @media (max-width: 768px) {
            .main-fab { width: 45px; height: 45px; font-size: 20px; bottom: 20px; right: 15px; }
            .mini-fab { width: 38px; height: 38px; font-size: 14px; }
            .fab-container { bottom: 20px; right: 15px; }
            .mobile-search-btn { position: absolute; top: 10px; right: 60px; font-size: 18px; color: #d4af37; cursor: pointer; padding: 5px; display: block; }
        }
        @media (min-width: 769px) { .mobile-search-btn { display: none; } }

        /* =========================================
           5. SIMPLE FOOTER (Restored)
           ========================================= */
        .royal-footer {
            background: #1a1a1a; color: #d4af37; padding: 20px 0; text-align: center;
            border-top: 4px solid #800000; margin-top: 50px;
        }
        /* No Social Icons, Simple & Classy */

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; }
        .modal-box { background: #fffbf0; border: 3px solid #d4af37; width: 90%; max-width: 400px; margin: 20% auto; padding: 25px; border-radius: 10px; position: relative; }
        .modal-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #d4af37; border-radius: 4px; }
        .gold-btn { background: #800000; color: #d4af37; border: 1px solid #d4af37; padding: 8px 15px; font-weight: bold; cursor: pointer; width: 100%; }
        
        /* Tooltip */
        #hoverTooltip { position: fixed; display: none; background: rgba(0,0,0,0.95); color: #fff; padding: 10px; border-radius: 4px; font-size: 12px; z-index: 20000; pointer-events: none; border: 1px solid #d4af37; max-width: 250px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="loadingOverlay">
        <img src="klogo1.png" alt="Logo" class="breathing-logo">
        <div style="font-family:'Cinzel'; color:#800000; font-size:1.2em;">|| ‡§µ‡§Ç‡§∂‡§æ‡§µ‡§≤‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à ||</div>
    </div>

    <div class="navbar-wrapper">
        <div class="container">
            <nav class="navbar navbar-inverse">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
                        <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
                    </button>
                    <div class="mobile-search-btn" onclick="toggleLeftPanel()"><i class="fas fa-search"></i></div>
                    <a class="navbar-brand" href="index.html">
                        <img src="menulogo.png" alt="Logo" class="menu-logo-img"> KASUMALGARH
                    </a>
                </div>
                <div id="navbar" class="collapse navbar-collapse">
                   <ul class="nav navbar-nav navbar-right">
                        <li><a href="index.html">HOME</a></li>
                        <li class="dropdown active">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">VANSHAWALI <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="vanshawali.html">Kasumalgarh</a></li>
                                <li><a href="rathorevanshawali.html">Rathore</a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">HISTORY <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="kasumalgarh.html">Kasumalgarh History</a></li>
                                <li><a href="rathore.html">Rathore History</a></li>
                            </ul>
                        </li>
                        <li><a href="gallery.html">GALLERY</a></li>
                        <li><a href="contact.html">CONTACT</a></li>
                        <li class="hidden-xs"><a href="#" onclick="toggleLeftPanel()"><i class="fas fa-search"></i> Search</a></li>
                        <li><a href="#" onclick="openRequestModal()"><i class="fas fa-user-plus"></i> Add</a></li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>

    <header class="index-header" style="min-height: 250px; padding-top: 100px; background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('fort_kasumbi.png');">
        <div class="container">
            <h1 class="shining-text" style="font-size: 2.5em;">|| ‡§µ‡§Ç‡§∂‡§æ‡§µ‡§≤‡•Ä ||</h1>
            <div style="font-family: 'Cinzel'; color: #d4af37; letter-spacing: 2px; text-transform: uppercase;">Thikana Kasumbi (Jakhlan)</div>
        </div>
    </header>

    <div class="tree-container" id="treeWrapper">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div id="treeArea" style="display: inline-block; min-width: 100%; transform-origin: top left; transition: transform 0.3s;">
                        <div class="royal-tree" id="royalTreeArea"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <aside class="sidebar-left" id="leftPanel">
        <div class="panel-header">
            <span><i class="fas fa-list"></i> Member Index</span>
            <i class="fas fa-times" onclick="toggleLeftPanel()" style="cursor:pointer; font-size:20px;"></i>
        </div>
        <div class="search-container">
            <input type="text" id="searchBox" class="search-box-panel" placeholder="‡§®‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." onkeyup="filterIndex()">
            <i class="fas fa-times clear-search" id="clearSearchBtn" onclick="clearSearch()"></i>
        </div>
        <div class="panel-content"><ul class="index-list" id="indexList"></ul></div>
    </aside>

    <aside class="sidebar-right" id="rightPanel">
        <div class="panel-header">
            <span><i class="fas fa-info-circle"></i> Family Details</span>
            <i class="fas fa-times" onclick="closeRightPanel()" style="cursor:pointer; font-size:20px;"></i>
        </div>
        <div class="panel-content" id="captureTarget" style="background: #fffbf0; position:relative;">
            <div id="memberDetails" style="text-align: center; margin-bottom: 20px;"></div>
            <h5 style="color:#800000; font-family:'Cinzel'; border-bottom: 1px dashed #d4af37; padding-bottom: 5px;">Ancestral Path (‡§µ‡§Ç‡§∂‡§æ‡§µ‡§≤‡•Ä ‡§ï‡•ç‡§∞‡§Æ)</h5>
            <div id="ancestralPath" style="margin-top: 15px;"></div>
            <div style="margin-top:30px; font-size:10px; color:#999; text-align:center; border-top:1px solid #ebd5a0; padding-top:10px;">
                Generated by Kasumalgarh.site
            </div>
        </div>
    </aside>

    <div id="hoverTooltip"></div>

    <div class="fab-container">
        <div class="main-fab" onclick="toggleFab(this)"><i class="fas fa-plus"></i></div>
        <div class="fab-options" id="fabOptions">
            <button class="mini-fab" onclick="shareWhatsApp()" title="Share on WhatsApp" style="background:#25D366; color:#fff; border-color:#25D366;"><i class="fab fa-whatsapp"></i></button>
            <button class="mini-fab" onclick="toggleFullScreen()" title="Full Screen"><i class="fas fa-expand"></i></button> 
            <button class="mini-fab" onclick="resetTree()" title="Reset Tree"><i class="fas fa-sync-alt"></i></button>
            <button class="mini-fab" onclick="zoomIn()" title="Zoom In"><i class="fas fa-plus"></i></button>
            <button class="mini-fab" onclick="zoomOut()" title="Zoom Out"><i class="fas fa-minus"></i></button>
            <button class="mini-fab" onclick="captureRightPanel()" title="Download Full HD" style="background:#2ecc71; color:#fff; border-color:#27ae60;"><i class="fas fa-camera"></i></button>
        </div>
    </div>

    <div id="requestModal" class="modal-overlay">
        <div class="modal-box">
            <span onclick="closeRequestModal()" style="position:absolute; right:15px; top:10px; font-size:24px; cursor:pointer; color:#800000;">&times;</span>
            <h4 style="color:#800000; text-align:center; font-family:'Cinzel';">Request Correction</h4>
            <input type="text" id="reqName" class="modal-input" placeholder="Your Name">
            <textarea id="reqMsg" class="modal-input" rows="4" placeholder="Details..."></textarea>
            <button onclick="sendRequest()" class="gold-btn">Send Request</button>
        </div>
    </div>

    <footer class="royal-footer">
        <div class="container">
            <div style="font-size: 0.9em; color: #ccc; margin-bottom: 5px;">Developed & Designed By:</div>
            <div style="color:#d4af37; font-size:1.4rem; font-family: 'Cinzel', serif; margin-bottom: 5px;">Yuvraj Gajraj Singh</div>
            <div style="font-size: 0.8em; color: #888;">&copy; <span id="year">2026</span> Kasumalgarh</div>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> 
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="royal_global.js"></script>
    <script src="family-data.js"></script>

    <script>
        let allMembers = [];
        let currentZoom = 1;
        let isRightPanelOpen = false;
        let rootNodeName = "";

        // --- 1. TREE GENERATION ---
        function generateTreeHTML(member, isRoot, depth) {
            if (!member) return '';
            if(isRoot) rootNodeName = member.name;
            let uniqueId = "node-" + Math.floor(Math.random() * 10000000);
            allMembers.push({ name: member.name, id: uniqueId, depth: depth, data: member });

            let hasChild = (member.children && member.children.length > 0);
            let liClass = isRoot ? 'root-li gen-1' : (hasChild ? `has-children gen-${depth}` : `gen-${depth}`);
            let nameClass = isRoot ? 'root-name' : 'tree-name';
            
            let toggleBtn = hasChild ? `<span class="toggle-btn" data-id="${uniqueId}">+</span>` : '';
            let hint = isRoot ? `<span class="click-hint" id="rootHint">üëà ‡§µ‡§Ç‡§∂‡§æ‡§µ‡§≤‡•Ä ‡§ñ‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡§¨‡§æ‡§è‡§Ç (Tap)</span>` : '';

            let html = `<li class="${liClass}" id="li-${uniqueId}">`;
            html += `<div class="tree-name-wrapper">
                        ${toggleBtn}
                        <span class="${nameClass}" id="${uniqueId}" data-id="${uniqueId}">${member.name}</span>
                        ${hint}
                     </div>`;

            if (hasChild) {
                let ulClass = isRoot ? 'root-ul' : 'children-group';
                let ulStyle = 'style="display:none;"'; 
                html += `<ul class="${ulClass}" ${ulStyle}>`;
                member.children.forEach(child => { html += generateTreeHTML(child, false, depth + 1); });
                html += '</ul>';
            }
            html += '</li>';
            return html;
        }

        // --- 2. LOGIC & EVENTS ---
        $(window).on('load', function() {
            setTimeout(() => { $('#loadingOverlay').fadeOut(); $('.tree-container').addClass('loaded'); }, 800);
        });

        $(document).ready(function() {
            if (typeof familyData !== 'undefined') {
                allMembers = [];
                let treeHTML = '<ul class="root-ul">' + generateTreeHTML(familyData, true, 1) + '</ul>';
                $('#royalTreeArea').html(treeHTML);
                populateIndex();
            } else {
                $('#royalTreeArea').html('<h3 style="color:red; text-align:center;">Data File Missing!</h3>');
            }

            // Event Delegation (Buttons)
            $(document).on('click', '.toggle-btn', function(e) {
                e.stopPropagation();
                let btn = $(this), ul = btn.closest('li').children('ul');
                $('#rootHint').fadeOut();
                if(ul.is(':visible')) { ul.slideUp(200); btn.text('+'); } 
                else { ul.slideDown(200); btn.text('-'); }
            });

            // Event Delegation (Names) - GOLDEN PATH TRIGGER
            $(document).on('click', '.tree-name, .root-name', function(e) {
                showDetails($(this).attr('data-id'), e);
            });

            $(document).on('mouseenter', '.tree-name', function(e) {
                 if(window.innerWidth > 768) showTooltip($(this).attr('data-id'), e);
            }).on('mouseleave', '.tree-name', function() { hideTooltip(); });
        });

        // --- 3. DETAILS & GOLDEN PATH ---
        function getMemberInfo(id) {
            let el = $('#' + id);
            let memberObj = allMembers.find(m => m.id === id);
            let pathArray = [];
            
            // STRICT SELECTION & HIGHLIGHT
            $('.is-ancestor').removeClass('is-ancestor'); // Reset old path
            el.parents('li').each(function() {
                $(this).addClass('is-ancestor'); // Highlight this path
                let span = $(this).find('> .tree-name-wrapper > .tree-name');
                if(span.length > 0) pathArray.push(span.text().trim());
            });

            let fatherName = pathArray.length > 1 ? pathArray[1] : "Founder";
            let parentLi = el.closest('ul').parent('li');
            let siblings = [], myIndex = 1;
            
            if(parentLi.length) {
                parentLi.find('> ul > li').each(function(idx) {
                    if($(this).attr('id') !== el.closest('li').attr('id')) {
                        siblings.push($(this).find('> .tree-name-wrapper > .tree-name').text().trim());
                    } else { myIndex = idx + 1; }
                });
            }

            let suffix = (myIndex===1)?'st':(myIndex===2)?'nd':(myIndex===3)?'rd':'th';
            let nameLower = memberObj.name.toLowerCase();
            let childType = (nameLower.includes('baisa')||nameLower.includes('bai')) ? "Daughter" : "Son";
            let sibNamesStr = siblings.length > 0 ? `<br><span style="font-size:11px; color:#800000;">(${siblings.join(', ')})</span>` : "";

            return {
                name: memberObj.name,
                father: fatherName,
                relation: (siblings.length+1===1)? `Only ${childType}` : `${myIndex}${suffix} ${childType}`,
                siblingsDesc: siblings.length>0 ? `He has ${siblings.length} more siblings` : `Only Child`,
                sibNames: sibNamesStr,
                gen: memberObj.depth,
                path: pathArray.reverse()
            };
        }

        function showDetails(id, e) {
            e.stopPropagation();
            $('.highlight-node').removeClass('highlight-node');
            $('#' + id).addClass('highlight-node');

            let info = getMemberInfo(id);

            let detailsHTML = `
                <div class="gen-seal"><span class="gen-label">Gen</span><br>${info.gen}</div>
                <h3 style="color:#800000; font-family:'Cinzel'; margin-top:5px;">${info.name}</h3>
                <div style="background:#fffbe6; padding:15px; border:1px solid #d4af37; border-radius:5px; font-family:'Merriweather'; font-size:13px; line-height:1.8;">
                    <strong>${info.relation}</strong> of <strong>${info.father}</strong><br>
                    <span style="color:#555;">${info.siblingsDesc} ${info.sibNames}</span>
                </div>
            `;
            $('#memberDetails').html(detailsHTML);

            let pathHTML = '';
            info.path.forEach((name, idx) => {
                let isLast = idx === info.path.length - 1;
                let style = isLast ? "color:#800000; font-weight:bold; background:#fff0d0; padding:2px 5px; border-radius:3px;" : "";
                pathHTML += `<div class="path-node"><span style="${style}">${name}</span></div>`;
            });
            $('#ancestralPath').html(pathHTML);

            $('#rightPanel').addClass('open'); $('#leftPanel').removeClass('open'); isRightPanelOpen = true;
        }

        function showTooltip(id, e) {
            let info = getMemberInfo(id);
            $('#hoverTooltip').html(`<strong style="color:#d4af37">${info.name}</strong><br>${info.relation} of ${info.father}<br>Gen: ${info.gen}`).css({top:e.clientY+15, left:e.clientX+15}).show();
        }
        function hideTooltip() { $('#hoverTooltip').hide(); }

        // --- 4. CAPTURE & TOOLS ---
        function shareWhatsApp() {
            let url = window.location.href;
            window.open(`whatsapp://send?text=‡§¶‡•á‡§ñ‡§ø‡§è ‡§†‡§ø‡§ï‡§æ‡§®‡§æ ‡§ï‡§∏‡•Ç‡§Å‡§≠‡•Ä (‡§ú‡§æ‡§ñ‡§≤‡§æ‡§Ç) ‡§ï‡•Ä ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§µ‡§Ç‡§∂‡§æ‡§µ‡§≤‡•Ä: ${url}`);
        }

        function captureRightPanel() {
            if(!isRightPanelOpen) { alert("Please select a member first."); return; }
            let btn = $('.mini-fab[title="Download Full HD"] i');
            btn.attr('class', 'fas fa-spinner fa-spin');

            let currentName = $('#memberDetails h3').text().replace(/ /g, "_");
            let clone = document.getElementById("captureTarget").cloneNode(true);
            
            // Add Photo Watermark (Name)
            let watermark = document.createElement("div");
            watermark.innerHTML = "Yuvraj Gajraj Singh";
            watermark.style.cssText = "position:absolute; top:50%; left:50%; transform:translate(-50%, -50%) rotate(-45deg); font-size:30px; color:rgba(0,0,0,0.1); font-weight:bold; font-family:'Cinzel'; white-space:nowrap; z-index:0;";
            clone.appendChild(watermark);

            clone.style.width = "320px"; clone.style.height = "auto"; clone.style.maxHeight = "none"; clone.style.overflow = "visible";
            clone.style.position = "fixed"; clone.style.top = "-10000px"; clone.style.left = "0"; clone.style.background = "#fffbf0"; clone.style.zIndex = "5000";
            document.body.appendChild(clone);

            html2canvas(clone, { scale: 4, backgroundColor: "#fffbf0", useCORS: true }).then(canvas => {
                let link = document.createElement('a');
                link.download = `Vanshawali_${currentName}.png`;
                link.href = canvas.toDataURL();
                link.click();
                document.body.removeChild(clone);
                btn.attr('class', 'fas fa-camera');
            }).catch(e => { console.log(e); btn.attr('class', 'fas fa-camera'); });
        }

        // Utils
        function toggleLeftPanel() { $('#leftPanel').toggleClass('open'); closeRightPanel(); }
        function closeRightPanel() { $('#rightPanel').removeClass('open'); isRightPanelOpen = false; }
        function toggleFab(btn) { $(btn).toggleClass('active'); $('#fabOptions').toggleClass('show'); }
        function zoomIn() { if(currentZoom < 3) currentZoom += 0.1; $('#treeArea').css('transform', `scale(${currentZoom})`); }
        function zoomOut() { if(currentZoom > 0.3) currentZoom -= 0.1; $('#treeArea').css('transform', `scale(${currentZoom})`); }
        function resetTree() { $('.children-group').slideUp(); $('.toggle-btn').text('+'); currentZoom=1; $('#treeArea').css('transform', `scale(1)`); closeRightPanel(); $('#rootHint').fadeIn(); $('.is-ancestor').removeClass('is-ancestor'); }
        function toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(()=>{}); } else { if (document.exitFullscreen) document.exitFullscreen(); } }

        // Search
        function populateIndex() { let l=$('#indexList'); l.empty(); [...allMembers].sort((a,b)=>a.name.localeCompare(b.name)).forEach(m=>l.append(`<li onclick="jumpToNode('${m.id}')">${m.name}</li>`)); }
        function filterIndex() { let v=$('#searchBox').val().toLowerCase(); $('#clearSearchBtn').toggle(v.length>0); $('#indexList li').toggle(function(){return $(this).text().toLowerCase().indexOf(v)>-1}); }
        function clearSearch() { $('#searchBox').val(''); filterIndex(); }
        function jumpToNode(id) { toggleLeftPanel(); let el=$('#'+id); $(el).parents('ul').show(); $(el).parents('li').children('.tree-name-wrapper').find('.toggle-btn').text('-'); setTimeout(()=>{el.scrollIntoView({behavior:"smooth",block:"center"}); $(el).trigger('click');},300); }
        
        function openRequestModal(){$('#requestModal').fadeIn();} function closeRequestModal(){$('#requestModal').fadeOut();}
        function sendRequest(){ let n=$('#reqName').val(), m=$('#reqMsg').val(); if(!n||!m) return; emailjs.send("service_vdnox8p", "template_xx3a4tt", {from_name:n, message:m}).then(()=>{alert("Sent!");closeRequestModal();}); }
        
        // Auto Close
        $(document).click(function(e) { 
            if(!$(e.target).closest('#rightPanel, .tree-name, .toggle-btn, .fab-container').length && $('#rightPanel').hasClass('open')) closeRightPanel();
            if(!$(e.target).closest('#leftPanel, .navbar-nav, .mobile-search-btn').length && $('#leftPanel').hasClass('open')) $('#leftPanel').removeClass('open');
        });
    </script>
</body>
</html>
